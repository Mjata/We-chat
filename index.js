\nimport express from \'express\';\nimport admin from \'./firebase-config.js\';\nimport axios from \'axios\';\nimport { pesapalConfig } from \'./pesapal-config.js\';\nimport { v4 as uuidv4 } from \'uuid\';\n\nconst app = express();\napp.use(express.json());\n\n// --- Database Collection Names ---\nconst USERS_COLLECTION = \'we_chat_users\';\nconst TRANSACTIONS_COLLECTION = \'pesapal_transactions\';\n\n// --- CONFIGURATION CONSTANTS ---\nconst CALL_COST_PER_MINUTE = 50;\nconst ADMOB_REWARD_AMOUNT = 20;\n\n// --- Pesapal API Configuration ---\nconst PESAPAL_API = \'https://cybqa.pesapal.com/pesapalv3\'; // Sandbox URL\nconst PESAPAL_CALLBACK_URL_BASE = \'https://we-chat-1-flwd.onrender.com\'; // Your app\'s public URL\n\n// --- MIDDLEWARE ---\nconst authMiddleware = async (req, res, next) => {\n  const authHeader = req.headers.authorization;\n  if (!authHeader || !authHeader.startsWith(\'Bearer \')) {\n    return res.status(401).json({ error: \'Unauthorized: No token provided.\' });\n  }\n  const idToken = authHeader.split(\'Bearer \')[1];\n  try {\n    req.user = await admin.auth().verifyIdToken(idToken);\n    if (!req.user.email) {\n        const firebaseUser = await admin.auth().getUser(req.user.uid);\n        req.user.email = firebaseUser.email;\n    }\n    next();\n  } catch (error) {\n    console.error(\"Auth middleware error:\", error);\n    res.status(403).json({ error: \'Unauthorized: Invalid token.\' });\n  }\n};\n\n// --- PESAPAL HELPER ---\nlet pesapalAuthToken = null;\nlet tokenExpiry = null;\nconst getPesapalToken = async () => {\n    if (pesapalAuthToken && tokenExpiry && new Date() < tokenExpiry) return pesapalAuthToken;\n    try {\n        const response = await axios.post(`${PESAPAL_API}/api/Auth/RequestToken`, {\n            consumer_key: pesapalConfig.consumerKey,\n            consumer_secret: pesapalConfig.consumerSecret,\n        });\n        pesapalAuthToken = response.data.token;\n        tokenExpiry = new Date(new Date().getTime() + 290 * 1000);\n        return pesapalAuthToken;\n    } catch (error) {\n        console.error(\'Error getting Pesapal token:\', error.response ? error.response.data : error.message);\n        throw new Error(\'Could not authenticate with Pesapal.\');\n    }\n};\n\n// --- USER, ACCOUNT & PERMISSIONS ---\napp.post(\'/api/setupNewUser\', authMiddleware, /* ... Existing setup user code ... */ );\n\n// --- RECHARGE & PAYMENT ---\nconst COIN_PACKAGES = { \'pack1\': { coins: 100, price: 5.00 }, \'pack2\': { coins: 550, price: 20.00 }, \'pack3\': { coins: 1200, price: 50.00 } };\n\napp.post(\'/api/recharge/initiate\', authMiddleware, /* ... Existing initiate payment code ... */ );\n\n// Pesapal IPN Listener (Webhook)\napp.get(\'/api/recharge/webhook\', (req, res) => {\n  console.log(\'GET /api/recharge/webhook - PesaPal URL Registration\');\n  res.status(200).json({\n    order_notification_type: \"GET\",\n    timestamp: new Date().toISOString(),\n    status: \"200\",\n    message: \"Callback URL successfully registered\"\n  });\n});\n\napp.post(\'/api/recharge/webhook\', async (req, res) => {\n  console.log(\'POST /api/recharge/webhook - Received PesaPal IPN:\', JSON.stringify(req.body, null, 2));\n\n  const { OrderMerchantReference, OrderTrackingId, OrderNotificationType } = req.body;\n\n  // We only care about the final payment notification\n  if (OrderNotificationType !== \"IPNCHANGE\") {\n    return res.status(200).json({ message: \"Acknowledged, but not the notification type we process.\" });\n  }\n\n  const db = admin.firestore();\n  const transactionRef = db.collection(TRANSACTIONS_COLLECTION).doc(OrderMerchantReference);\n\n  try {\n    // Use a transaction to ensure atomicity\n    await db.runTransaction(async (t) => {\n        const transactionDoc = await t.get(transactionRef);\n\n        if (!transactionDoc.exists) {\n            console.error(`Webhook Error: Transaction with MerchantReference ${OrderMerchantReference} not found.`);\n            // Still return 200 to PesaPal, as we can\'t recover from this.\n            return;\n        }\n        \n        const transactionData = transactionDoc.data();\n\n        // Idempotency check: If transaction is already completed or failed, do nothing.\n        if (transactionData.status === \'COMPLETED\' || transactionData.status === \'FAILED\') {\n            console.log(`Webhook Info: Transaction ${OrderMerchantReference} already processed.`);\n            return;\n        }\n\n        // Get the final status of the transaction from PesaPal API\n        const token = await getPesapalToken();\n        const statusResponse = await axios.get(`${PESAPAL_API}/api/Transactions/GetTransactionStatus?orderTrackingId=${OrderTrackingId}`, {\n            headers: { Authorization: `Bearer ${token}` }\n        });\n\n        const paymentStatus = statusResponse.data.payment_status_description.toUpperCase();\n\n        if (paymentStatus === \'COMPLETED\') {\n            console.log(`Processing COMPLETED payment for ${OrderMerchantReference}`);\n            const userRef = db.collection(USERS_COLLECTION).doc(transactionData.userId);\n\n            // Update transaction status and user coins in one atomic operation\n            t.update(transactionRef, { \n                status: \'COMPLETED\', \n                pesapalTrackingId: OrderTrackingId,\n                paymentStatus: paymentStatus,\n                processedAt: admin.firestore.FieldValue.serverTimestamp()\n            });\n            t.update(userRef, {\n                coins: admin.firestore.FieldValue.increment(transactionData.coins)\n            });\n\n        } else if ([\'FAILED\', \'INVALID\', \'CANCELLED\'].includes(paymentStatus)) {\n            console.log(`Processing FAILED payment for ${OrderMerchantReference}`);\n            // Just update the transaction status to FAILED\n            t.update(transactionRef, { \n                status: \'FAILED\',\n                pesapalTrackingId: OrderTrackingId,\n                paymentStatus: paymentStatus,\n                processedAt: admin.firestore.FieldValue.serverTimestamp()\n            });\n        } else {\n            // For other statuses (e.g., PENDING), we don\'t do anything yet.\n            console.log(`Payment for ${OrderMerchantReference} is still ${paymentStatus}. No action taken.`);\n        }\n    });\n\n    // Acknowledge receipt of the IPN\n    res.status(200).json({\n        order_notification_type: \"POST\",\n        timestamp: new Date().toISOString(),\n        status: \"200\",\n        message: \"IPN received and processed.\"\n    });\n\n  } catch (error) {\n    console.error(\`Webhook FATAL Error for ${OrderMerchantReference}: \`, error.response ? error.response.data : error.message);\n    // We respond 500 here so PesaPal might retry. But be cautious about retry loops.\n    res.status(500).json({ error: \"Internal server error processing webhook.\" });\n  }\n});\n\n// --- LIVE STREAMING ---\napp.post(\'/api/livestreams/start\', authMiddleware, /* ... */ );\napp.post(\'/api/livestreams/stop\', authMiddleware, /* ... */ );\napp.get(\'/api/livestreams\', authMiddleware, /* ... */ );\n\n// --- VIDEO & VOICE CALLS ---\napp.post(\'/api/calls/start\', authMiddleware, /* ... */ );\napp.post(\'/api/calls/charge\', authMiddleware, /* ... */ );\napp.post(\'/api/calls/end\', authMiddleware, /* ... */ );\n\n// --- ADMOB & REWARDS ---\napp.post(\'/api/rewards/grant-ad-reward\', authMiddleware, /* ... */ );\n\nconst port = parseInt(process.env.PORT) || 3000;\napp.listen(port, () => console.log(`Server is running on port ${port}`));\n